# Структура проекта TravelPi

## Обзор

TravelPi - защищенный роутер для путешествий на базе Raspberry Pi Zero 2W с веб-интерфейсом управления.

## Структура файлов

```
travelpi/
├── config/                          # Конфигурационные файлы системы
│   ├── hostapd.conf                # Настройки точки доступа Wi-Fi
│   ├── dnsmasq.conf                # Настройки DHCP и DNS
│   ├── dhcpcd.conf                 # Настройки сетевых интерфейсов
│   ├── nginx-travelpi.conf         # Конфигурация веб-сервера
│   └── iptables-restore.service    # Служба восстановления iptables
│
├── database/                        # База данных
│   └── schema.sql                  # Схема БД (пользователи, устройства, сессии, трафик)
│
├── scripts/                         # Системные скрипты
│   ├── connection-manager.sh       # Управление подключением к интернету
│   ├── device-monitor.sh           # Мониторинг подключенных устройств
│   └── dns-monitor.sh              # Мониторинг DNS запросов и посещенных ресурсов
│
├── systemd/                         # Службы systemd
│   ├── travelpi-connection.service # Служба управления подключением
│   ├── travelpi-monitor.service    # Служба мониторинга устройств
│   └── travelpi-dns-monitor.service# Служба мониторинга DNS
│
├── www/                             # Веб-интерфейс
│   ├── public/                     # Публичные файлы
│   │   ├── connect.php             # Страница настройки подключения
│   │   ├── monitoring.php          # Страница мониторинга ресурсов
│   │   ├── history.php             # История подключений
│   │   ├── devices.php             # Управление устройствами
│   │   ├── users.php               # Управление пользователями
│   │   ├── pihole.php              # Интеграция с Pi-hole
│   │   ├── login.php               # Страница входа
│   │   ├── logout.php              # Выход
│   │   ├── api.php                 # REST API
│   │   ├── css/
│   │   │   └── style.css           # Стили интерфейса
│   │   └── js/
│   │       ├── app.js              # Общие функции
│   │       ├── connect.js          # Управление подключениями
│   │       ├── monitoring.js       # Мониторинг в реальном времени
│   │       ├── devices.js          # Управление устройствами
│   │       └── users.js            # Управление пользователями
│   │
│   └── includes/                   # PHP библиотеки
│       ├── auth.php                # Авторизация
│       └── db.php                  # Работа с базой данных
│
├── setup.sh                         # Скрипт автоматической установки
├── README.md                        # Описание проекта
├── INSTALL.md                       # Инструкция по установке
├── USAGE.md                         # Руководство пользователя
└── .gitignore                       # Игнорируемые файлы

```

## Архитектура системы

### Сетевая архитектура

```
Интернет
    ↓
[USB Wi-Fi (wlan1)] или [USB LAN (eth0)]
    ↓
Raspberry Pi Zero 2W (TravelPi)
    ↓
[Встроенный Wi-Fi (wlan0)] - Точка доступа
    ↓
Клиентские устройства (192.168.4.0/24)
```

### Компоненты

1. **hostapd** - Точка доступа Wi-Fi
2. **dnsmasq** - DHCP и DNS сервер
3. **iptables** - Маршрутизация и фильтрация трафика
4. **nginx** - Веб-сервер
5. **PHP-FPM** - Обработка PHP
6. **SQLite** - База данных
7. **Pi-hole** - Блокировка рекламы

### Потоки данных

#### Подключение к интернету
```
1. Пользователь выбирает сеть в веб-интерфейсе
2. API сохраняет сеть в БД
3. connection-manager.sh подключается к сети
4. Создается новая сессия в БД
5. Начинается учет трафика
```

#### Мониторинг трафика
```
1. dns-monitor.sh отслеживает DNS запросы
2. Домены записываются в session_resources
3. Статистика трафика обновляется каждые 5 секунд
4. Данные отображаются в веб-интерфейсе
```

#### Контроль доступа устройств
```
1. device-monitor.sh сканирует DHCP leases
2. Новые устройства добавляются в БД
3. Проверяется статус is_allowed
4. Заблокированные устройства фильтруются через iptables
```

## База данных

### Таблицы

- **users** - Пользователи веб-интерфейса
- **devices** - Устройства с доступом к роутеру
- **wifi_networks** - Сохраненные Wi-Fi сети
- **connection_sessions** - Сессии подключений к интернету
- **session_resources** - Посещенные ресурсы во время сессий
- **device_traffic** - Статистика трафика по устройствам
- **connection_logs** - Логи подключений устройств
- **settings** - Настройки системы

## API Endpoints

### Подключение
- `GET /api.php?action=scan_wifi` - Сканирование Wi-Fi сетей
- `POST /api.php?action=connect_wifi` - Подключение к сети
- `POST /api.php?action=disconnect` - Отключение от сети
- `POST /api.php?action=set_mode` - Установка режима подключения

### Мониторинг
- `GET /api.php?action=monitoring_stats` - Статистика системы и сессии
- `GET /api.php?action=stats` - Системная статистика

### Устройства
- `GET /api.php?action=devices` - Список подключенных устройств
- `POST /api.php?action=block_device` - Блокировка устройства
- `POST /api.php?action=allow_device` - Разрешение устройства
- `POST /api.php?action=update_device_name` - Обновление имени устройства

### Пользователи
- `POST /api.php?action=add_user` - Добавление пользователя
- `POST /api.php?action=block_user` - Блокировка пользователя
- `POST /api.php?action=allow_user` - Разрешение пользователя
- `POST /api.php?action=reset_user_password` - Сброс пароля
- `POST /api.php?action=delete_user` - Удаление пользователя

## Безопасность

### Меры защиты

1. **Авторизация** - Все страницы защищены паролем
2. **Хеширование паролей** - Использование password_hash()
3. **SQL инъекции** - Prepared statements в PDO
4. **XSS** - htmlspecialchars() для вывода данных
5. **Контроль доступа** - Проверка is_allowed для устройств и пользователей
6. **Блокировка рекламы** - Pi-hole на уровне DNS

### Рекомендации

- Сменить пароль администратора после установки
- Использовать сложные пароли для Wi-Fi
- Регулярно обновлять систему
- Проверять список подключенных устройств
- Блокировать неизвестные устройства

## Производительность

### Оптимизация для Raspberry Pi Zero 2W

- Легковесная ОС (Raspberry OS Lite)
- SQLite вместо MySQL
- Минимальный набор служб
- Кеширование статических файлов в nginx
- Оптимизированные SQL запросы

### Ограничения

- Максимум 20 одновременных подключений
- Рекомендуемая температура: до 70°C
- Скорость Wi-Fi: до 150 Mbps (USB адаптер)
- Скорость LAN: до 1000 Mbps (USB адаптер)

## Разработка

### Требования

- PHP 8.2+
- SQLite 3
- Nginx
- Linux (Raspberry OS)

### Добавление новых функций

1. Обновить схему БД в `database/schema.sql`
2. Добавить функции в `www/includes/db.php`
3. Создать API endpoint в `www/public/api.php`
4. Добавить страницу в `www/public/`
5. Создать JS функции в `www/public/js/`
6. Обновить стили в `www/public/css/style.css`

## Лицензия

MIT License
